<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Pasant√≠as UCE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { border: none; shadow: 0 0 15px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .stat-card { border-left: 4px solid #0d6efd; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-mortarboard-fill"></i> Plataforma UCE
            </a>
            <div class="d-flex text-white align-items-center">
                <span class="me-3">
                    Hola, <strong>{{ user.name }}</strong> 
                    <span class="badge bg-secondary ms-1">{{ user.role|upper }}</span>
                </span>
                <a href="/logout" class="btn btn-outline-light btn-sm">Cerrar Sesi√≥n</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        
        <div id="statusAlert" class="alert" style="display:none;"></div>

        {% if user.role == 'admin' %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card stat-card p-3 mb-3 bg-white shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">Panel de Control</h4>
                            <small class="text-muted">Gesti√≥n de Datos Maestros</small>
                        </div>
                        <button onclick="downloadReport()" class="btn btn-success">
                            <i class="bi bi-file-earmark-pdf"></i> Descargar Reporte Unificado
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-6">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-person-plus"></i> Registrar Estudiante (SQL)
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Nombre Completo</label>
                            <input type="text" id="stdName" class="form-control" placeholder="Ej: Juan Perez">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Correo Institucional</label>
                            <input type="email" id="stdEmail" class="form-control" placeholder="juan@uce.edu.ec">
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Promedio (GPA)</label>
                                <input type="number" id="stdGpa" class="form-control" step="0.1" placeholder="9.0">
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Carrera</label>
                                <select id="stdDept" class="form-select">
                                    <option>Ingenier√≠a</option>
                                    <option>Arquitectura</option>
                                    <option>Medicina</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="createStudent()" class="btn btn-primary w-100">Guardar en PostgreSQL</button>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <i class="bi bi-briefcase"></i> Publicar Oportunidad (NoSQL)
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">T√≠tulo del Puesto</label>
                            <input type="text" id="oppTitle" class="form-control" placeholder="Ej: Desarrollador Backend">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Empresa</label>
                            <input type="text" id="oppCompany" class="form-control" placeholder="Ej: Tech Solutions">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Requisito Flexible (JSON)</label>
                            <textarea id="oppReq" class="form-control" rows="3" placeholder='Ej: {"ingles": "B2", "experiencia": "Ninguna"}'></textarea>
                            <small class="text-muted">Escribe un JSON v√°lido o texto simple.</small>
                        </div>
                        <button onclick="createOpportunity()" class="btn btn-warning w-100">Guardar en MongoDB</button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if user.role == 'student' %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-white shadow-sm p-4">
                    <h3>üöÄ Oportunidades Disponibles</h3>
                    <p class="text-muted">Explora las ofertas almacenadas en nuestra base NoSQL (MongoDB).</p>
                </div>
            </div>
        </div>

        <div id="opportunities-container" class="row g-4">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p>Cargando ofertas desde MongoDB...</p>
            </div>
        </div>
        {% endif %}

    </div>

    <script>
        async function createStudent() {
            const data = {
                name: document.getElementById('stdName').value,
                email: document.getElementById('stdEmail').value,
                gpa: parseFloat(document.getElementById('stdGpa').value),
                department: document.getElementById('stdDept').value
            };
            sendRequest('/api/students', data, 'Estudiante guardado en PostgreSQL');
        }

        async function createOpportunity() {
            let reqs = document.getElementById('oppReq').value;
            // Intentar parsear si es JSON, sino mandar texto plano en un objeto
            try { reqs = JSON.parse(reqs); } catch(e) { reqs = { "nota": reqs }; }

            const data = {
                title: document.getElementById('oppTitle').value,
                company_name: document.getElementById('oppCompany').value,
                description: "Creado desde Dashboard Admin",
                requirements: reqs
            };
            sendRequest('/api/opportunities', data, 'Oportunidad guardada en MongoDB');
        }

        async function sendRequest(url, data, successMsg) {
            const alertBox = document.getElementById('statusAlert');
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                alertBox.style.display = 'block';
                if (response.ok) {
                    alertBox.className = 'alert alert-success';
                    alertBox.innerHTML = `‚úÖ ${successMsg}`;
                } else {
                    alertBox.className = 'alert alert-danger';
                    alertBox.innerHTML = `‚ùå Error: ${result.error || 'Desconocido'}`;
                }
            } catch (err) {
                console.error(err);
            }
        }

        function downloadReport() {
            window.location.href = '/api/reports/combined';
        }
        async function loadOpportunities() {
            const container = document.getElementById('opportunities-container');
            if (!container) return; // Si no es estudiante, este div no existe

            try {
                const response = await fetch('/api/opportunities');
                const opportunities = await response.json();

                container.innerHTML = ''; // Limpiar spinner

                if (opportunities.length === 0) {
                    container.innerHTML = '<div class="col-12 text-center">No hay ofertas publicadas a√∫n.</div>';
                    return;
                }

                opportunities.forEach(opp => {
                    // Manejo din√°mico de requisitos (JSON flexible)
                    let reqsHtml = '';
                    if (opp.requirements) {
                        // Si es string (legacy) o objeto
                        const reqObj = typeof opp.requirements === 'string' ? JSON.parse(opp.requirements) : opp.requirements;
                        
                        // Iteramos las claves del JSON NoSQL
                        for (const [key, val] of Object.entries(reqObj)) {
                            reqsHtml += `<span class="badge bg-info text-dark me-1">${key}: ${val}</span>`;
                        }
                    }

                    const card = `
                        <div class="col-md-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title text-primary">${opp.title || 'Sin T√≠tulo'}</h5>
                                    <h6 class="card-subtitle mb-2 text-muted">${opp.company_name || 'Empresa Confidencial'}</h6>
                                    <p class="card-text">${opp.description || ''}</p>
                                    <div class="mb-3">
                                        ${reqsHtml}
                                    </div>
                                    <button onclick="applyToOpportunity('${opp.id}')" class="btn btn-outline-primary w-100">
                                        Aplicar Ahora
                                    </button>
                                </div>
                                <div class="card-footer text-muted small">
                                    Ref Mongo: ${opp.id}
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += card;
                });

            } catch (err) {
                console.error(err);
                container.innerHTML = '<div class="alert alert-danger">Error cargando datos.</div>';
            }
        }

        async function applyToOpportunity(oppId) {
            if (!confirm("¬øEst√°s seguro de aplicar a esta vacante?")) return;

            // Buscamos el bot√≥n para deshabilitarlo visualmente
            // (Truco: usamos el evento click, pero como llamamos la funci√≥n directo, 
            // lo ideal ser√≠a pasar el bot√≥n 'this' como argumento, pero lo haremos simple)
            
            try {
                const response = await fetch('/api/applications', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ opportunity_id: oppId })
                });

                const result = await response.json();

                if (response.ok) {
                    alert("‚úÖ ¬°√âxito! Tu postulaci√≥n ha sido registrada.\nReferencia #" + result.ref);
                    // Opcional: Recargar para actualizar estado
                } else {
                    alert("‚ùå Error: " + result.error);
                }
            } catch (err) {
                console.error(err);
                alert("Error de conexi√≥n");
            }
        }

        // Ejecutar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', loadOpportunities);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>